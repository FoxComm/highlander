---
# Deploy client configs for Sensu

  - name: Check Sensu config directory
    file:
      dest: "{{ sensu_config_path }}/conf.d"
      state: directory
      recurse: true
      owner: "{{ sensu_user_name }}"
      group: "{{ sensu_group_name }}"

  - name: Create Sensu client RabbitMQ transport config
    template:
      dest: "{{ sensu_config_path }}/conf.d/rabbitmq.json"
      owner: "{{ sensu_user_name }}"
      group: "{{ sensu_group_name }}"
      src: rabbitmq.json.j2
    when: sensu_transport == "rabbitmq"

  - name: Create Sensu client Redis transport config
    template:
      dest: "{{ sensu_config_path }}/conf.d/redis.json"
      owner: "{{ sensu_user_name }}"
      group: "{{ sensu_group_name }}"
      src: sensu-redis.json.j2
    when: sensu_transport == "redis"

  - name: Create Sensu client transport config
    template:
      dest: "{{ sensu_config_path }}/conf.d/transport.json"
      owner: "{{ sensu_user_name }}"
      group: "{{ sensu_group_name }}"
      src: transport.json.j2
    notify: restart sensu-client service

  - name: Create Sensu client main config
    template:
      dest: "{{ sensu_config_path }}/conf.d/client.json"
      owner: "{{ sensu_user_name }}"
      group: "{{ sensu_group_name }}"
      src: client.json.j2
    notify: restart sensu-client service

  - name: Start Sensu client
    service: 
      name: sensu-client
      state: started
      enabled: yes
