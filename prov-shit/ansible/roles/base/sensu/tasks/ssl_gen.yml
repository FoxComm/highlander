---
# Create SSL and deployment data store for clients

  - name: Check Sensu SSL directory
    file: dest="{{ sensu_config_path }}/ssl" state=directory owner=root group=root

  - name: Check Sensu SSL gen directory
    file: dest="{{ sensu_config_path }}/ssl_generation" state=directory owner=root group=root
    when: sensu_master

  - block:

    - name: Unpack SSL tool from sensuapp.org
      unarchive:
      args:
        src: https://sensuapp.org/docs/{{ sensu_version }}/files/sensu_ssl_tool.tar
        dest: "{{ sensu_config_path }}/ssl_generation/"
        creates: "{{ sensu_config_path }}/ssl_generation/sensu_ssl_tool"
        copy: no

    - name: Generate SSL certs
      command: "{{ sensu_config_path }}/ssl_generation/sensu_ssl_tool/ssl_certs.sh generate"
      args:
        chdir: "{{ sensu_config_path }}/ssl_generation/sensu_ssl_tool"
        creates: "{{ sensu_config_path }}/ssl_generation/sensu_ssl_tool/server"

    when: sensu_master|bool

  - name: Store Sensu SSL certs
    fetch: src="{{ sensu_config_path }}/ssl_generation/sensu_ssl_tool/{{ item }}" dest={{ dynamic_data_store }}
    with_items:
      - sensu_ca/cacert.pem
      - server/cert.pem
      - server/key.pem
      - client/cert.pem
      - client/key.pem
    when: sensu_master
