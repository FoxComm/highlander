---
# Install RabbitMQ (Sensu Transport)

  - name: Add RabbitMQ repo key
    apt_key: url="{{ rabbitmq_repo_key }}" state=present

  - name: Add RabbitMQ repo
    apt_repository: repo="{{ rabbitmq_repo }}" state=present update_cache=true

  - name: Install RabbitMQ
    apt: name=rabbitmq-server state=present update_cache=true

  - name: Check RabbitMQ SSL directory
    file: dest={{ rabbitmq_config_path }}/ssl state=directory

  - name: Install RabbitMQ SSL certs
    copy: src={{ item }} dest={{ rabbitmq_config_path }}/ssl
    with_items:
      - "{{ sensu_ssl_server_cacert }}"
      - "{{ sensu_ssl_server_cert }}"
      - "{{ sensu_ssl_server_key }}"
    notify:
      - restart rabbitmq service
      - restart sensu-api service
      - restart sensu-server service

  - name: Create RabbitMQ config
    template: dest="{{ rabbitmq_config_path }}/rabbitmq.config" src=rabbitmq.config.j2 owner=root group=root
    notify: restart rabbitmq service

  - name: Start RabbitMQ
    service: name=rabbitmq-server state=started enabled=true

  - name: Create RabbitMQ vhost for sensu
    rabbitmq_vhost: name={{ rabbitmq_sensu_vhost }} state=present

  - name: Create Sensu RabbitMQ user
    rabbitmq_user: user="{{ rabbitmq_sensu_user }}"
                   password="{{ rabbitmq_sensu_password }}"
                   vhost="{{ rabbitmq_sensu_vhost }}"
                   configure_priv=.*
                   read_priv=.*
                   write_priv=.*
                   state=present
