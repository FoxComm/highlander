---

- include_vars: "{{role_path}}/../secret_keys/files/aws/aws.yml"
  when: docker_registry_provider == "aws"

- name: Setup docker_registry config
  file: path=/etc/docker_registry/ state=directory
  pause: seconds=5

- name: Copy GCE Docker Registry Config
  template: src=config_gce.yml dest="/etc/docker_registry/config.yml"
  when: docker_registry_provider == "gce"
  pause: seconds=5

- name: Copy AWS Docker Registry Config
  template: src=config_aws.yml dest="/etc/docker_registry/config.yml"
  when: docker_registry_provider == "aws"
  pause: seconds=5

- name: Copy Service
  template: src=docker_registry.service dest="{{dest_services}}/docker_registry.service"
  pause: seconds=5

- name: Make Certs Directory
  file: path=/certs state=directory mode="600"
  pause: seconds=5

- name: Copy Cert
  copy: src="{{role_path}}/../secret_keys/files/certs/{{cert_path}}/docker/domain.crt" dest=/certs/domain.crt
  pause: seconds=5

- name: Copy Key
  copy: src="{{role_path}}/../secret_keys/files/certs/{{cert_path}}/docker/domain.key" dest=/certs/domain.key
  pause: seconds=5

- name: Reload Systemd for Docker Registry
  pause: seconds=5
  command: systemctl daemon-reload

- name: Restart Docker Registry Server
  service: name=docker_registry state=restarted enabled=yes
  pause: seconds=5

- name: Copy Consul Service File
  template: src=docker_registry.json dest="/etc/consul.d/docker_registry.json"
  pause: seconds=5
