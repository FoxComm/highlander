---

- name: Create middlewarehouse Directory
  file: path={{middlewarehouse_dir}} state=directory owner="{{user}}"
  sudo: true

- name: Create consumers Directory
  file: path={{middlewarehouse_consumers_dir}} state=directory owner="{{user}}"
  sudo: true

- name: Copy Binary
  copy: src={{middlewarehouse_bin_src}} dest={{middlewarehouse_bin}} mode="u+x,g+x,o+x"
  sudo: true

- name: Copy stock-items-consumer Binary
  copy: src={{stock_items_consumer_bin_src}} dest={{stock_items_consumer_bin}} mode="u+x,g+x,o+x"
  sudo: true

- name: Copy shipments-consumer Binary
  copy: src={{shipments_consumer_bin_src}} dest={{shipments_consumer_bin}} mode="u+x,g+x,o+x"
  sudo: true

- name: Synchronize middlewarehouse Sql
  synchronize: src="{{middlewarehouse_src}}/sql" dest="{{middlewarehouse_dir}}" delete=yes recursive=yes
  sudo: true

- name: Create empty .env file for middlewarehouse
  file: path="{{middlewarehouse_dir}}/.env.{{middlewarehouse_env}}" state=touch

- name: Create empty .env file for consumers
  file: path="{{middlewarehouse_consumers_dir}}/.env.{{middlewarehouse_env}}" state=touch

- name: Copy Middlewarehouse Service
  template: src=middlewarehouse.service dest="{{dest_services}}/middlewarehouse.service"
  sudo: true

- name: Copy stock-items-consumer Service
  template: src=stock-items-consumer.service dest="{{dest_services}}/stock-items-consumer.service"
  sudo: true

- name: Copy shipments-consumer Service
  template: src=shipments-consumer.service dest="{{dest_services}}/shipments-consumer.service"
  sudo: true

- name: Reload Systemd for middlewarehouse
  sudo: yes
  command: systemctl daemon-reload

- name: Restart middlewarehouse
  service: name=middlewarehouse state=restarted enabled=yes
  sudo: true

- name: Restart stock-items-consumer
  service: name=stock-items-consumer state=restarted enabled=yes
  sudo: true

- name: Restart shipments-consumer
  service: name=shipments-consumer state=restarted enabled=yes
  sudo: true

- name: Copy Consul Service File
  template: src=middlewarehouse.json dest="/etc/consul.d/middlewarehouse.json"
  sudo: true
  notify: reload consul
