---

- name: Update System Package Cache
  apt: update_cache=yes
  pause: seconds=5

- name: Install PostgreSQL Packages
  apt: name={{item}} state=latest force=yes
  pause: seconds=5
  with_items:
    - libpq-dev
    - python-psycopg2
    - python-dev
    - postgresql-server-dev-9.5
    - postgresql-9.5
    - postgresql-client-9.5
    - postgresql-contrib-9.5

- name: Install pgcli
  pip: name=pgcli state=present

- include: flyway_install.yml

- name: Copy Postgres Configuration
  copy: src={{item}} dest="/etc/postgresql/9.5/main/{{item}}" mode="0644"
  pause: seconds=5
  with_items:
      - postgresql.conf
      - pg_hba.conf

- name: Reload Systemd for Postgresql
  pause: seconds=5
  command: systemctl daemon-reload

- name: Restart Postgresql
  service: name=postgresql state=restarted
  pause: seconds=5

- name: Copy Consul Service File
  template: src=db.json dest="/etc/consul.d/db.json"
  pause: seconds=5
