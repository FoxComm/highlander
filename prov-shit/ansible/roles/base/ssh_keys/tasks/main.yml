---

- name: Install Private Key So Buildkite Agents Can Work
  become: true
  copy: src=id_rsa dest={{ item }} mode="0600"
  with_items:
    - "/var/lib/buildkite-agent/.ssh/"
    - "/home/buildkite-agent/.ssh/"
    - "/home/{{user}}/.ssh/"
    - "/home/root/.ssh/"

- name: Install Public SSH Keys
  become: true
  copy: src=id_rsa.pub dest={{ item }} mode="u=rw,g=r,o=r"
  with_items:
    - "/var/lib/buildkite-agent/.ssh/"
    - "/home/buildkite-agent/.ssh/"
    - "/home/{{user}}/.ssh/"
    - "/home/root/.ssh/"

- name: Update SSH config
  become: true
  copy: src=config dest={{ item }} mode="u=rw,g=r,o=r"
  with_items:
    - "/var/lib/buildkite-agent/.ssh/"
    - "/home/buildkite-agent/.ssh/"
    - "/home/{{user}}/.ssh/"
    - "/home/root/.ssh/"

- name: Correct Ownership
  become: true
  file: path="/home/{{item}}/.ssh/" state=directory owner={{item}} group={{item}} recurse=yes
  with_items:
    - "{{user}}"
    - "root"
