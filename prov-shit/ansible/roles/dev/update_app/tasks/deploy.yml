---

- name: Copy Application Marathon JSON
  template: src={{app_template_path}} dest=/tmp

- name: Delete Application in Marathon
  shell: 'curl -sS -XDELETE http://{{consul_services.marathon}}/v2/apps/{{app_name_marathon}}'

- name: Create Application in Marathon
  shell: 'curl -sS -XPOST -d@/tmp/{{app_name}}.json -H "Content-Type: application/json" http://{{consul_services.marathon}}/v2/apps?force=true'

- name: Pause for 15 seconds
  pause: seconds=15

- name: Get Application Marathon tasks in `healthy` state
  shell: curl -sS -XGET http://{{consul_services.marathon}}/v2/apps/{{app_name_marathon}} | jq '.app.tasksHealthy > 0'
  register: healthy_tasks_available
  until: healthy_tasks_available.stdout == 'true'
  retries: "{{marathon_retries}}"
  delay: "{{marathon_delay}}"

- name: Cleanup
  file: path=/tmp/{{app_name}}.json state=absent
