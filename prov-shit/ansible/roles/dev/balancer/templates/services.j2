upstream search {
  {{ '{{' }} range service "elasticsearch" {{ '}}'}} server {{ '{{'}} .Address {{ '}}' }}:{{ '{{' }} .Port {{ '}}' }} max_fails=10 fail_timeout=30s weight=1;
  {{ '{{' }} else {{ '}}' }} server {{consul_services.es_http}} fail_timeout=30s max_fails=10; {{ '{{' }} end {{ '}}' }}
}

# We use port 9090 for phoenix
upstream phoenix {
  {{ '{{' }} range service "phoenix" {{ '}}'}} server {{ '{{'}} .Address {{ '}}' }}:9090 max_fails=10 fail_timeout=30s weight=1;
  {{ '{{' }} else {{ '}}' }} server {{consul_services.phoenix}} fail_timeout=30s max_fails=10; {{ '{{' }} end {{ '}}' }}
}

upstream isaac {
  {{ '{{' }} range service "isaac" {{ '}}'}} server {{ '{{'}} .Address {{ '}}' }}:{{ '{{' }} .Port {{ '}}' }} max_fails=10 fail_timeout=30s weight=1;
  {{ '{{' }} else {{ '}}' }} server {{consul_services.isaac}} fail_timeout=30s max_fails=10; {{ '{{' }} end {{ '}}' }}
}

# We use port 9292 for middlewarehouse
upstream middlewarehouse {
  {{ '{{' }} range service "middlewarehouse" {{ '}}'}} server {{ '{{'}} .Address {{ '}}' }}:9292 max_fails=10 fail_timeout=30s weight=1;
  {{ '{{' }} else {{ '}}' }} server {{consul_services.middlewarehouse}} fail_timeout=30s max_fails=10; {{ '{{' }} end {{ '}}' }}
}

# We use port 4002 for solomon
upstream sol {
  {{ '{{' }} range service "solomon" {{ '}}'}} server {{ '{{'}} .Address {{ '}}' }}:4002 max_fails=10 fail_timeout=30s weight=1;
  {{ '{{' }} else {{ '}}' }} server {{consul_services.solomon}} fail_timeout=30s max_fails=10; {{ '{{' }} end {{ '}}' }}
}

upstream ashes {
  {{ '{{' }} range service "ashes" {{ '}}'}} server {{ '{{'}} .Address {{ '}}' }}:{{ '{{' }} .Port {{ '}}' }} max_fails=10 fail_timeout=30s weight=1;
  {{ '{{' }} else {{ '}}' }} server {{consul_services.ashes}} fail_timeout=30s max_fails=10; {{ '{{' }} end {{ '}}' }}
}

upstream marathon {
  {{ '{{' }} range service "marathon" {{ '}}'}} server {{ '{{'}} .Address {{ '}}' }}:{{ '{{' }} .Port {{ '}}' }} max_fails=10 fail_timeout=30s weight=1;
  {{ '{{' }} else {{ '}}' }} server {{consul_services.marathon}} fail_timeout=30s max_fails=10; {{ '{{' }} end {{ '}}' }}
}
