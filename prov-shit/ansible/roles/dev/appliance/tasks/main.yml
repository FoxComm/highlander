---

- name: Remove DPKG Lock
  file: path=/var/lib/dpkg/lock state=absent

- name: Remove Unattended Upgrades
  apt: name=unattended-upgrades state=absent

- name: Remove Daily Apt
  file: path=/etc/cron.daily/apt-compat state=absent

- name: Set Hostname
  hostname: name={{appliance_hostname}}
  when: local_vagrant

- name: Override Mesos Worker Script
  template: src=run_mesos_worker.sh dest=/usr/local/bin mode="u+x,g+x,o+x" force=yes

- name: Copy Mesos Resources Config
  template: src=resources.json dest=/var/lib/mesos/resources.json mode="u+r,g+r,o+r"

- name: Stop Services
  service: name={{item}} state=stopped enabled=true
  with_items:
    - docker
    - zookeeper
    - kafka
    - schema-registry
    - bottledwater_phoenix
    - bottledwater_middlewarehouse
    - bottledwater_marketplace
    - mesos_master
    - mesos_worker
    - marathon
  when: item != "bottledwater_marketplace" or with_marketplace

- name: Purge Zookeeper Data
  file: path=/var/lib/zookeeper state=absent

- name: Create Zookeeper Dir
  file: path=/var/lib/zookeeper state=directory

- name: Purge Kafka Queue
  file: path=/var/lib/kafka state=absent

- name: Create Kafka Dir
  file: path=/var/lib/kafka state=directory

- name: Start Services
  service: name={{item}} state=started enabled=true
  with_items:
    - docker
    - zookeeper
    - kafka
    - schema-registry
    - bottledwater_phoenix
    - bottledwater_middlewarehouse
    - bottledwater_marketplace
    - mesos_master
    - mesos_worker
    - marathon
  when: item != "bottledwater_marketplace" or with_marketplace
