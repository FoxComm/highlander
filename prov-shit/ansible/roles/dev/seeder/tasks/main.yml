---

- name: Get Latest Phoenix Image
  shell: docker pull {{docker_registry}}:5000/phoenix:{{docker_branch}}
  become: true

- name: Seed Phoenix Database
  shell: docker run --network host -t {{docker_registry}}:5000/phoenix:{{docker_branch}} java -Dphoenix.env={{phoenix_env}} -Ddb.host={{db_host}} -Ddb.url=jdbc:postgresql://{{db_host}}/{{db_name}}?user={{db_user}} -Ddb.name={{db_name}} -cp {{phoenix_jar}} {{seeds_cmd}}
  become: true
  when: with_base_seeds is defined and with_base_seeds

- name: Wait for Phoenix to become available
  wait_for: host={{phoenix_host}} port={{phoenix_port}} timeout=1200

- name: Gatling Seed Db
  shell: docker run --network host -t {{docker_registry}}:5000/phoenix:{{docker_branch}} java -Dphoenix.env={{phoenix_env}} -Dapp.baseUrl=http://{{phoenix_server}} -Dhttp.interface={{phoenix_host}} -Ddb.host={{db_host}} -Ddb.url=jdbc:postgresql://{{db_host}}/{{db_name}}?user={{db_user}} -Ddb.name={{db_name}} -cp {{phoenix_jar}} {{gatling_oneshot_seeds_cmd}}
  become: true
  when: with_gatling_seeder

- name: Copy Service
  template: src=seeder.service dest="{{dest_services}}/seeder.service"
  become: true
  when: with_seeder

- name: Reload Systemd for Seeder
  become: yes
  command: systemctl daemon-reload
  when: with_seeder

- name: Restart Seeder
  service: name=seeder state=restarted enabled=yes
  become: true
  when: with_seeder

- name: Create Middlewarehouse Seeder directory
  file: path={{middlewarehouse_dir}}/seeder state=directory
  become: true

- name: Copy Middlewarehouse Seeder .env
  template: src=middlewarehouse.env dest={{middlewarehouse_dir}}/seeder/.env
  become: true

- name: Get Latest Middlewarehouse Image
  shell: docker pull {{docker_registry}}:5000/middlewarehouse-seeder:{{docker_branch}}
  become: true

- name: Run Middlewarehouse Seeder docker container
  command: docker run --env-file "{{middlewarehouse_dir}}/seeder/.env" --network host {{docker_registry}}:5000/middlewarehouse-seeder:{{docker_branch}}
  become: true
