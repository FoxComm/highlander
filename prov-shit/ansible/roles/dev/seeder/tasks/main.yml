---

- name: Synchronize Phoenix SQL
  synchronize: src="{{phoenix_src}}/sql" dest="{{phoenix_dir}}" delete=yes recursive=yes
  sudo: true

- name: Delete Phoenix Gatling Resources
  file: path="{{phoenix_dir}}/gatling-classes" state=absent
  sudo: true

- name: Delete Phoenix Gatling Results
  file: path="{{phoenix_dir}}/gatling-results" state=absent
  sudo: true

- name: Synchronize Phoenix Gatling Resources
  synchronize: src="{{phoenix_src}}/gatling-classes" dest="{{phoenix_dir}}" delete=yes recursive=yes
  sudo: true

- name: Create Directory for Gatling results
  file: path="{{phoenix_dir}}/gatling-results" state=directory owner="{{user}}" mode="0777"
  sudo: true

- name: Seed Phoenix Database
  shell: java -Dphoenix.env={{phoenix_env}} -Ddb.host={{db_host}} -Ddb.url="jdbc:postgresql://{{db_host}}/{{db_name}}?user={{db_user}}" -Ddb.name={{db_name}} -cp {{phoenix_jar}} {{seeds_cmd}}
  sudo: true
  args:
    chdir: "{{phoenix_dir}}"

- name: Gatling Seed Db
  shell: java -Dphoenix.env={{phoenix_env}} -Ddb.host={{db_host}} -Ddb.url="jdbc:postgresql://{{db_host}}/{{db_name}}?user={{db_user}}" -Ddb.name={{db_name}} -cp {{phoenix_jar}} {{gatling_oneshot_seeds_cmd}}
  sudo: true
  args:
    chdir: "{{phoenix_dir}}"

- name: Synchronize Middlewarehouse Seeder
  synchronize: src="{{middlewarehouse_src}}/seeder" dest="{{middlewarehouse_dir}}" delete=yes
  sudo: true

- name: Seed Middlewarehouse Database
  shell: DB_HOST={{db_host}} DB_NAME={{middlewarehouse_db_name}} DB_USER={{middlewarehouse_db_user}}
  sudo: true
  args:
    chdir: "{{middlewarehouse_dir}}"

- name: Copy Service
  template: src=seeder.service dest="{{dest_services}}/seeder.service"
  sudo: true
  when: with_seeder

- name: Reload Systemd for Seeder
  sudo: yes
  command: systemctl daemon-reload
  when: with_seeder

- name: Restart Seeder
  service: name=seeder state=restarted enabled=yes
  sudo: true
  when: with_seeder
