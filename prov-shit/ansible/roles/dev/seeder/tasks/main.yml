---

- name: Restart Postgres
  service: name=postgresql state=restarted enabled=yes

- name: Get Latest Phoenix Image
  shell: docker pull {{docker_registry}}:5000/phoenix:{{docker_tags.phoenix}}
  when: with_base_seeds is defined and with_base_seeds

- name: Seed Phoenix Database
  shell: docker run --network host -t {{docker_registry}}:5000/phoenix:{{docker_tags.phoenix}} java -Dphoenix.env={{phoenix_env}} -Ddb.host={{db_host}} -Ddb.url=jdbc:postgresql://{{db_host}}/{{db_name}}?user={{db_user}} -Ddb.name={{db_name}} -cp {{phoenix_jar}} {{seeds_cmd}}
  when: with_base_seeds is defined and with_base_seeds

- name: Wait for Phoenix to become available
  wait_for: host={{phoenix_host}} port={{phoenix_port}} timeout=1200
  when: with_base_seeds is defined and with_base_seeds

- name: Gatling Seed Db
  shell: docker run --network host -t {{docker_registry}}:5000/phoenix:{{docker_tags.phoenix}} java -Dphoenix.env={{phoenix_env}} -Dapp.baseUrl=http://{{phoenix_server}} -Dhttp.interface={{phoenix_host}} -Ddb.host={{db_host}} -Ddb.url=jdbc:postgresql://{{db_host}}/{{db_name}}?user={{db_user}} -Ddb.name={{db_name}} -cp {{phoenix_jar}} {{gatling_oneshot_seeds_cmd}}
  when: with_gatling_seeder is defined and with_gatling_seeder

- name: Create Middlewarehouse Seeder directory
  file: path={{middlewarehouse_dir}}/seeder state=directory
  when: with_mwh_seeder is defined and with_mwh_seeder

- name: Copy Middlewarehouse Seeder .env
  template: src=middlewarehouse.env dest={{middlewarehouse_dir}}/seeder/.env
  when: with_mwh_seeder is defined and with_mwh_seeder

- name: Get Latest Middlewarehouse Image
  shell: docker pull {{docker_registry}}:5000/middlewarehouse-seeder:{{docker_tags.middlewarehouse}}
  when: with_mwh_seeder is defined and with_mwh_seeder

- name: Run Middlewarehouse Seeder docker container
  command: docker run --env-file "{{middlewarehouse_dir}}/seeder/.env" --network host {{docker_registry}}:5000/middlewarehouse-seeder:{{docker_tags.middlewarehouse}}
  when: with_mwh_seeder is defined and with_mwh_seeder
