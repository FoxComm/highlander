---

- name: Get Consul services in `warning` state
  shell: 'curl -sS -XGET http://{{consul_services.consul}}/v1/health/state/warning'
  register: consul_warning_services_output

- name: Ensure there is no services in `warning` state
  fail: msg="Detected Consul services in `warning` state"
  when: consul_warning_services_output.stdout != "[]"

- name: Get Consul services in `critical` state
  shell: 'curl -sS -XGET http://{{consul_services.consul}}/v1/health/state/critical'
  register: consul_critical_services_output

- name: Ensure there is no services in `critical` state
  fail: msg="Detected Consul services in `critical` state"
  when: consul_critical_services_output.stdout != "[]"

- name: Get Marathon services in `unhealthy` state
  shell: 'curl -sS -XGET http://{{consul_services.marathon}}/v2/apps | {{jq_query}}'
  register: marathon_unhealthy_services_output

- name: Ensure there is no services in `critical` state
  fail: msg="Detected Marathon services in `critical` state"
  when: marathon_unhealthy_services_output.stdout != "0"
