---

- name: Get consul services in `warning` state
  shell: 'curl -sS -XGET http://{{consul_server}}/v1/health/state/warning'
  register: consul_warning_services_output

- name: Ensure there is no services in `warning` state
  fail: msg="Detected consul services in `warning` state"
  when: consul_warning_services_output.stdout != "[]"

- name: Get consul services in `critical` state
  shell: 'curl -sS -XGET http://{{consul_server}}/v1/health/state/critical'
  register: consul_critical_services_output

- name: Ensure there is no services in `critical` state
  fail: msg="Detected consul services in `critical` state"
  when: consul_warning_services_output.stdout != "[]"

- name: Get marathon services in `unhealthy` state
  shell: 'curl -sS -XGET http://{{marathon_server}}/v2/apps | jq '.apps[] | select(.tasksUnhealthy != 0)' | wc -l | xargs'
  register: marathon_unhealthy_services_output

- name: Ensure there is no services in `critical` state
  fail: msg="Detected consul services in `critical` state"
  when: marathon_unhealthy_services_output.stdout != "0"
