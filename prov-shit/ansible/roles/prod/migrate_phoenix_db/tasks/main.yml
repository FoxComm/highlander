---

- include_vars: ../../../base/db/vars/main.yml

- include: ../../../base/db/tasks/flyway_install.yml
  when: download_flyway

- name: Synchronize Phoenix SQL
  synchronize: src="{{phoenix_src}}/sql" dest="{{phoenix_dir}}" delete=yes recursive=yes
  

- name: Synchronize Middlewarehouse SQL
  synchronize: src="{{middlewarehouse_src}}/sql" dest="{{middlewarehouse_dir}}" delete=yes recursive=yes
  

- name: Repair Flyway Schema
  shell: sudo -u root FLYWAY_HOME={{flyway_dir}} {{flyway}} repair
  args:
    chdir: "{{phoenix_dir}}"

- name: Migrate Database
  shell: sudo -u root FLYWAY_HOME={{flyway_dir}} {{flyway}} migrate
  args:
    chdir: "{{phoenix_dir}}"

- name: Setup Update Materialized Views SQL
  copy: src={{role_path}}/../../dev/db/files/update_materialized_views.sql dest={{update_materialized_views_sql}}
  
