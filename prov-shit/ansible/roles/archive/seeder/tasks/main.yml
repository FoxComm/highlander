---

- name: Synchronize Phoenix SQL
  synchronize: src="{{phoenix_src}}/sql" dest="{{phoenix_dir}}" delete=yes recursive=yes

- name: Delete Phoenix Gatling Resources
  file: path="{{phoenix_dir}}/gatling-classes" state=absent

- name: Delete Phoenix Gatling Results
  file: path="{{phoenix_dir}}/gatling-results" state=absent

- name: Synchronize Phoenix Gatling Resources
  synchronize: src="{{phoenix_src}}/gatling-classes" dest="{{phoenix_dir}}" delete=yes recursive=yes

- name: Create Directory for Gatling results
  file: path="{{phoenix_dir}}/gatling-results" state=directory owner="{{user}}" mode="0777"

- name: Seed Phoenix Database
  shell: java -Dphoenix.env={{phoenix_env}} -Ddb.host={{db_host}} -Ddb.url="jdbc:postgresql://{{db_host}}/{{db_name}}?user={{db_user}}" -Ddb.name={{db_name}} -cp {{phoenix_jar}} {{seeds_cmd}}
  args:
    chdir: "{{phoenix_dir}}"

- name: Gatling Seed Db
  shell: java -Dphoenix.env={{phoenix_env}} -Ddb.host={{db_host}} -Ddb.url="jdbc:postgresql://{{db_host}}/{{db_name}}?user={{db_user}}" -Ddb.name={{db_name}} -cp {{phoenix_jar}} {{gatling_oneshot_seeds_cmd}}
  args:
    chdir: "{{phoenix_dir}}"
  when: with_gatling_seeder

- name: Copy Service
  template: src=seeder.service dest="{{dest_services}}/seeder.service"
  when: with_seeder

- name: Reload Systemd for Seeder
  command: systemctl daemon-reload
  when: with_seeder

- name: Restart Seeder
  service: name=seeder state=restarted enabled=yes
  when: with_seeder

- name: Create Middlewarehouse Seeder directory
  file: path={{middlewarehouse_dir}}/seeder state=directory
  when: with_mwh_seeder

- name: Copy Middlewarehouse Seeder .env
  template: src=middlewarehouse.env dest={{middlewarehouse_dir}}/seeder/.env
  when: with_mwh_seeder

- name: Run Middlewarehouse Seeder docker container
  command: docker run --env-file "{{middlewarehouse_dir}}/seeder/.env" --network host "{{docker_registry}}:5000/middlewarehouse-seeder:{{docker_branch}}"
  when: with_mwh_seeder
