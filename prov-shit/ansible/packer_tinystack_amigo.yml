---

- name: Packing Tinystack Amigo
  hosts: all
  vars:
    user: ubuntu
    packing: true
    join_type: join-wan
    mesos_quorum: 1
    consul_expect: 1

  pre_tasks:
    - name: Wait for apt unlock
      shell: while sudo fuser /var/lib/dpkg/lock >/dev/null 2>&1; do sleep 1; done;
      become: true

  roles:
    - { role: base/consul_server }
    - { role: base/zookeeper }
    - { role: base/docker_registry }
    - { role: base/mesos_master }
    - { role: base/mesos_consul }
    - { role: base/kibana, sudo: yes }
    - { role: base/sensu, sensu_subscriptions: ["consul-server"] }
