---

- name: Update Application Docker Tag in Developer Appliance
  hosts: localhost
  connection: local
  vars:
    user: "{{ ansible_user | default(lookup('env', 'USER')) }}"
    marathon_server: "{{instance_ip}}:8080"
  vars_prompt:
    - name: "app_name"
      prompt: "Enter Highlander sub-project to re-deploy"
      default: "middlewarehouse"
      private: no
    - name: "branch_name"
      prompt: "Enter branch/tag to be deployed"
      default: "master"
      private: no
    - name: "auto_build"
      prompt: "Automatically build a branch/tag (y/n)?"
      default: "n"
      private: no
    - name: "instance_ip"
      prompt: "Override your appliance IP (optional)"
      default: "10.240.0.x"
      private: no
  pre_tasks:
    - name: Set IP/DNS Facts
      set_fact:
        private_ip: "{{ansible_default_ipv4.address}}"
        dns_record: "appliance-{{ansible_default_ipv4.address | replace(\".\", \"-\") }}"
    - name: Override hostnames
      set_fact:
        appliance_hostname: "{{dns_record}}.{{foxcomm_domain}}"
        ashes_server_name: "{{dns_record}}.{{foxcomm_domain}}"
        storefront_server_name: "{{dns_record}}.{{foxcomm_domain}}"

  roles:
    - { role: dev/update_app }
