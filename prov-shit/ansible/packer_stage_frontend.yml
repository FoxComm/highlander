---

- name: Provision Packer Twostack Frontend
  hosts: all
  tags:
      - packer-tinystack-frontend
  vars:
    user: ubuntu
    packing: true
    phoenix_server: phoenix.service.consul:9090
    search_host: elasticsearch.service.consul
    log_host: es-log.service.consul
    search_server_http: "{{search_host}}:9200"
    ashes_server: 127.0.0.1:4000
    storefront_server: storefront.service.consul:8080
    isaac_server: isaac.service.consul:9190
    middlewarehouse_server: middlewarehouse.service.consul:9292
    phoenix_service_requires: ""
    phoenix_service_after: ""
    middlewarehouse_service_requires: ""
    middlewarehouse_service_after: ""
    middlewarehouse_consumers_services_requires: ""
    middlewarehouse_consumers_services_after: ""
    greenriver_service_requires: phoenix.service
    greenriver_service_after: phoenix.service
    ashes_server_name: "stage.foxcommerce.com"
    storefront_server_name: "stage.foxcommerce.com"
    kafka_server: kafka.service.consul:9092
    schema_server: schema-registry.service.consul:8081
  post_tasks:
    - name: Sweet Dreams
      pause: seconds=5

  roles:
    - { role: base/ssh_keys }
    - { role: base/mesos_worker }
    - { role: base/rsyslog, sudo: yes }
    - { role: base/phoenix }
    - { role: base/isaac }
    - { role: base/greenriver }
    - { role: base/middlewarehouse }
    - { role: base/firebrand }
    - { role: base/balancer, sudo: yes }

  handlers:
     - include: roles/base/consul_agent/handlers/main.yml
