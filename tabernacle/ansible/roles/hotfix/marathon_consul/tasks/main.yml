---

- name: Add Marathon Consul APT key
  apt_key: url={{marathon_consul_apt_key_url}}

- name: Add Marathon Consul repository
  apt_repository: repo='deb {{marathon_consul_apt_url}} /' state=present update_cache=yes

- name: Install Marathon Consul
  apt: name=marathon-consul state=latest force=yes

- name: Install Marathon Consul config
  template: src=config.json dest={{marathon_consul_config_path}}

- name: Start Marathon Consul
  systemd: state=restarted enabled=yes daemon_reload=yes name=marathon-consul

- name: Copy Consul Service File
  template: src=marathon-consul.json dest="/etc/consul.d/marathon-consul.json"

- name: Reload Consul Configuration
  shell: consul reload

- name: Wait before marathon-consul.service.consul will be registered
  shell: 'ping -c 1 marathon-consul.service.consul'
  register: marathon_consul_host_ex
  until: marathon_consul_host_ex.rc == 0
  retries: "{{marathon_retries}}"
  delay: 2

- name: Wait before marathon.service.consul will be registered
  shell: 'ping -c 1 marathon.service.consul'
  register: marathon_host_ex
  until: marathon_host_ex.rc == 0
  retries: "{{marathon_retries}}"
  delay: 2

- name: Subscribe Marathon events to Marathon Consul
  command: curl -X POST 'http://marathon.service.consul:8080/v2/eventSubscriptions?callbackUrl=http://marathon-consul.service.consul:4000/events'
