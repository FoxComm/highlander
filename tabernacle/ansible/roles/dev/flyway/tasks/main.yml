---

- name: Create Directories
  file: path={{item}} state=directory owner="{{user}}"
  with_items:
    - "{{phoenix_dir}}"
    - "{{middlewarehouse_dir}}"
    - "{{hyperion_dir}}"

- name: Synchronize SQL
  synchronize: src={{item.source}} dest={{item.destination}} delete=yes recursive=yes
  with_items:
    - { source: "{{phoenix_src}}/sql", destination: "{{phoenix_dir}}" }
    - { source: "{{middlewarehouse_src}}/sql", destination: "{{middlewarehouse_dir}}" }
    - { source: "{{hyperion_src}}/sql", destination: "{{hyperion_dir}}" }

# Flyway on Phoenix
- name: Setup Phoenix Flyway Config
  template: src=flyway.phoenix.conf dest="{{phoenix_dir}}/sql/flyway.conf" mode="u+x,g+x,o+x"

- name: Clean Phoenix Database
  shell: FLYWAY_HOME={{flyway_dir}} {{flyway}} clean
  args:
    chdir: "{{phoenix_dir}}"

- name: Migrate Phoenix Database
  shell: FLYWAY_HOME={{flyway_dir}} {{flyway}} migrate
  args:
    chdir: "{{phoenix_dir}}"

# Flyway on Middlewarehouse
- name: Setup Middlewarehouse Flyway Config
  template: src=flyway.middlewarehouse.conf dest="{{middlewarehouse_dir}}/sql/flyway.conf" mode="u+x,g+x,o+x"

- name: Clean Middlewarehouse Database
  shell: FLYWAY_HOME={{flyway_dir}} {{flyway}} clean
  args:
    chdir: "{{middlewarehouse_dir}}"

- name: Migrate Middlewarehouse Database
  shell: FLYWAY_HOME={{flyway_dir}} {{flyway}} migrate
  args:
    chdir: "{{middlewarehouse_dir}}"

# Flyway on Hyperion
- name: Setup Hyperion Flyway Config
  template: src=flyway.hyperion.conf dest="{{hyperion_dir}}/sql/flyway.conf" mode="u+x,g+x,o+x"

- name: Clean Hyperion Database
  shell: FLYWAY_HOME={{flyway_dir}} {{flyway}} clean
  args:
    chdir: "{{hyperion_dir}}"

- name: Migrate Hyperion Database
  shell: FLYWAY_HOME={{flyway_dir}} {{flyway}} migrate
  args:
    chdir: "{{hyperion_dir}}"
