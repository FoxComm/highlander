<<- range $id, $app := .Apps >>
  upstream <<index $app.Hosts 0 >> {
    <<- range $app.Tasks >>
    server << .Host >>:<< index .Ports 0 >> max_fails=10 fail_timeout=30s weight=1;
    <<- end >>
  }
  server {
    <<- range $app.Hosts >>
    server_name << . >> << . >>.*;
    <<- end >>

    location / {
      proxy_set_header HOST $host;
      proxy_connect_timeout 30;
      proxy_http_version 1.1;
      proxy_pass http://<<index $app.Hosts 0 >>;
    }
  }
<<- end >>

{% if is_appliance %}
upstream dashboard {
   server {{dashboard_server}} max_fails=10 fail_timeout=30s weight=1;
}

upstream marathon {
   server {{marathon_server}} max_fails=10 fail_timeout=30s weight=1;
}

upstream pgweb {
   server {{pgweb_server}} max_fails=10 fail_timeout=30s weight=1;
}
{% endif %}
