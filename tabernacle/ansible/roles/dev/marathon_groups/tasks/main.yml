---

- include_vars: "{{role_path}}/../../base/secret_keys/files/aws/aws.yml"
- include_vars: stripe.yml
- include_vars: hyperion.yml
- include_vars: solomon.yml
- include_vars: suggester.yml

- name: Creates Marathon JSON directory
  file: path=/marathon/applications state=directory

- name: Copy Mapping Command
  template: src=create_es_mappings.sh dest=/usr/local/bin/create_es_mappings.sh mode="u+x,g+x,o+x"
  
- name: Create ES Mappings
  shell: /usr/local/bin/create_es_mappings.sh
  when: first_run

- name: Copy application group Marathon JSON
  template: src=highlander_group.json dest=/marathon/applications mode="u+rw,g+rw,o+r"

- name: Copy create Neo4j command
  template: src=create_neo4j_user.sh dest=/usr/local/bin/create_neo4j_user.sh mode="u+x,g+x,o+x"

- name: Kill Highlander group Tasks in Marathon
  shell: 'curl -sS -XDELETE http://{{marathon_server}}/v2/groups/highlander'
  when: is_redeploy

- name: Update Highlander group in Marathon
  shell: 'curl -sS -XPUT -d@/marathon/applications/highlander_group.json -H "Content-Type: application/json" http://{{marathon_server}}/v2/groups'
