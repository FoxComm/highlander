---

- include_vars: "{{role_path}}/../../base/secret_keys/files/aws/aws.yml"
- include_vars: stripe.yml
- include_vars: hyperion.yml
- include_vars: solomon.yml

- name: Creates Marathon JSON directory
  file: path=/marathon/applications state=directory

- name: Copy application group Marathon JSON
  template: src=highlander_group.json dest=/marathon/applications mode="u+rw,g+rw,o+r"

- name: Kill Highlander group Tasks in Marathon
  shell: 'curl -sS -XDELETE http://{{marathon_server}}/v2/groups/highlander'
  when: is_redeploy

- name: Update Highlander group in Marathon
  shell: 'curl -sS -XPUT -d@/marathon/applications/highlander_group.json -H "Content-Type: application/json" http://{{marathon_server}}/v2/groups'

# - name: Get Highlander group Marathon tasks in `healthy` state
#   shell: curl -sS -XGET http://{{marathon_server}}/v2/apps/highlander_group | jq '.app.tasksHealthy > 0'
#   register: healthy_tasks_available
#   until: healthy_tasks_available.stdout == 'true'
#   retries: "1000"
#   delay: "{{marathon_delay}}"
