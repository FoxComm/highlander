{
  "id": "/highlander",
  "groups": [
    {
      "id": "core",
      "apps": [
        {
            "id": "phoenix",
            "cmd": null,
            "cpus": 1,
            "mem": 4096,
            "disk": 0,
            "instances": 1,
            "labels": {
              "LAYER": "backend",
              "LANG": "scala",
              "consul": "phoenix",
              "TAG": "{{docker_tags.phoenix}}"
            },
            "env": {
              "PORT":"{{phoenix_port}}",
              "SCHEMA_REGISTRY_URL": "http://{{schema_server}}",
              "KAFKA_BROKER": "{{kafka_server}}",
              "PHOENIX_PUBLIC_KEY": "/keys/public_key.der",
              "PHOENIX_PRIVATE_KEY": "/keys/private_key.der",
              "PHOENIX_COOKIE_SECURE": "off",
              "PHOENIX_AUTH_METHOD": "jwt",
              "SEARCH_SERVER": "elasticsearch://{{search_server}}",
              "GOOGLE_OAUTH_ADMIN_CLIENT_ID": "{{google_oauth_admin_client_id}}",
              "GOOGLE_OAUTH_ADMIN_CLIENT_SECRET": "{{google_oauth_admin_secret}}",
              "GOOGLE_OAUTH_ADMIN_REDIRECT_URI": "{{google_oauth_admin_redirect_uri}}",
              "GOOGLE_OAUTH_ADMIN_HOSTED_DOMAIN": "{{google_oauth_admin_hosted_domain}}",
              "GOOGLE_OAUTH_CUSTOMER_CLIENT_ID": "{{google_oauth_frontend_client_id}}",
              "GOOGLE_OAUTH_CUSTOMER_CLIENT_SECRET": "{{google_oauth_frontend_secret}}",
              "GOOGLE_OAUTH_CUSTOMER_REDIRECT_URI": "{{google_oauth_frontend_redirect_uri}}",
              "AWS_ACCESS_KEY": "{{secret_key}}",
              "AWS_SECRET_KEY": "{{secret_access_key}}",
              "S3_BUCKET": "{{s3_bucket}}",
              "S3_REGION": "{{s3_region}}",
              "STRIPE_API_KEY": "{{stripe_api_key}}",
              "MIDDLEWAREHOUSE_URL": "http://{{middlewarehouse_server}}",
              "TAX_RULE_REGION": "{{phoenix_tax_rule_region}}",
              "TAX_RULE_RATE": "{{phoenix_tax_rule_rate}}",
              "JAVA_OPTS": "{% if jmx_enabled %}-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port={{phoenix_jmx_port}} -Dcom.sun.management.jmxremote.local.only=false -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false{% endif %} -Dphoenix.env={{phoenix_env}} -Dhttp.interface=0.0.0.0 -Ddb.host={{db_host}} -Ddb.url=jdbc:postgresql://{{db_host}}/{{db_name}}?user={{db_user}} -Ddb.name={{db_name}} -Dakka.tracing.host={{zipkin_collector}} -Dakka.tracing.enabled={{phoenix_tracing}} -Dauth.tokenTTL={{phoenix_token_ttl}}"
            },
            "ports": [{{phoenix_port}}],
            "healthChecks": [
              {
                "path": "/v1/public/ping",
                "protocol": "HTTP",
                "gracePeriodSeconds": 300,
                "intervalSeconds": 30,
                "timeoutSeconds": 20,
                "maxConsecutiveFailures": 3,
                "ignoreHttp1xx": false,
                "port": {{phoenix_port}}
              }
            ],
            "constraints": [["hostname", "UNIQUE"]],
            "container": {
              "type": "DOCKER",
              "volumes": [
                {
                  "containerPath": "/keys",
                  "hostPath": "{{public_keys_dest_dir}}",
                  "mode": "RO"
                },
                {
                  "containerPath": "{{docker_logs_dir}}",
                  "hostPath": "{{docker_logs_host_dir}}",
                  "mode": "RW"
                }
              ],
              "docker": {
                "image": "{{docker_registry}}:5000/phoenix:{{docker_tags.phoenix}}",
                "network": "HOST",
                "privileged": false,
                "parameters": [],
                "forcePullImage": true
              }
            }
        },
        {
          "id": "isaac",
          "cmd": null,
          "cpus": 0.25,
          "mem": 64,
          "disk": 0,
          "instances": 1,
          "labels": {
            "LAYER": "backend",
            "LANG": "cpp",
            "consul": "isaac",
            "TAG": "{{docker_tags.isaac}}"
          },
          "container": {
            "type": "DOCKER",
            "volumes": [
              {
                "containerPath": "/certs",
                "hostPath": "{{public_keys_dest_dir}}",
                "mode": "RO"
              },
              {
                "containerPath": "{{docker_logs_dir}}",
                "hostPath": "{{docker_logs_host_dir}}",
                "mode": "RW"
              }
            ],
            "docker": {
              "image": "docker-stage.foxcommerce.com:5000/isaac:{{docker_tags.isaac}}",
              "network": "HOST",
              "privileged": false,
              "parameters": [],
              "forcePullImage": true
            }
          },
          "env": {
            "PUBLIC_KEY": "/certs/public_key.pem",
            "DB_HOST": "{{docker_db_host}}",
            "DB_NAME": "{{phoenix_db_name}}",
            "DB_USER": "{{db_user}}"
          },
          "healthChecks": [
            {
              "path": "/ping",
              "protocol": "HTTP",
              "portIndex": 0,
              "gracePeriodSeconds": 300,
              "intervalSeconds": 30,
              "timeoutSeconds": 20,
              "maxConsecutiveFailures": 3,
              "ignoreHttp1xx": false
            }
          ],
          "portDefinitions": [
            {
              "port": 10000,
              "protocol": "tcp",
              "labels": {}
            }
          ]
        },
        {
          "id": "solomon",
          "cmd": null,
          "cpus": 0.5,
          "mem": 256,
          "disk": 0,
          "instances": 1,
          "labels": {
            "LAYER": "backend",
            "LANG": "elixir",
            "consul": "solomon",
            "TAG": "{{docker_tags.solomon}}"
          },
          "env": {
            "PORT": "{{solomon_port}}",
            "DB_USER": "{{db_user}}",
            "DB_HOST": "{{docker_db_host}}",
            "DB_NAME": "{{phoenix_db_name}}",
            "DB_PASSWORD": "",
            "PRIVATE_KEY": "{{private_keys_dest_dir}}/private_key.pem",
            "PUBLIC_KEY": "{{public_keys_dest_dir}}/public_key.pem",
            "TOKEN_TTL": "{{solomon_token_ttl}}",
            "SOLOMON_SECRET": "{{solomon_secret_token}}"
          },
          "ports": [{{solomon_port}}],
          "constraints": [["hostname", "UNIQUE"]],
          "container": {
            "type": "DOCKER",
            "volumes": [
              {
                "containerPath": "{{public_keys_dest_dir}}",
                "hostPath": "{{public_keys_dest_dir}}",
                "mode": "RO"
              },
              {
                "containerPath": "{{docker_logs_dir}}",
                "hostPath": "{{docker_logs_host_dir}}",
                "mode": "RW"
              }
            ],
            "docker": {
              "image": "{{docker_registry}}:5000/solomon:{{docker_tags.solomon}}",
              "network": "HOST",
              "privileged": false,
              "parameters": [],
              "forcePullImage": true
            }
          },
          "healthChecks": [
            {
              "path": "/ping",
              "protocol": "HTTP",
              "gracePeriodSeconds": 300,
              "intervalSeconds": 30,
              "timeoutSeconds": 20,
              "maxConsecutiveFailures": 3,
              "ignoreHttp1xx": false,
              "port": {{solomon_port}}
            }
          ]
        },
        {
            "id": "middlewarehouse",
            "cmd": null,
            "cpus": 0.25,
            "mem": 64,
            "disk": 0,
            "instances": 1,
            "labels": {
              "LAYER": "backend",
              "LANG": "go",
              "consul": "middlewarehouse",
              "TAG": "{{docker_tags.middlewarehouse}}"
            },
            "container": {
              "type": "DOCKER",
              "volumes": [
                {
                  "containerPath": "{{docker_logs_dir}}",
                  "hostPath": "{{docker_logs_host_dir}}",
                  "mode": "RW"
                }
              ],
              "docker": {
                "image": "{{docker_registry}}:5000/middlewarehouse:{{docker_tags.middlewarehouse}}",
                "network": "HOST",
                "privileged": false,
                "parameters": [],
                "forcePullImage": true
              }
            },
            "ports": [{{middlewarehouse_port}}],
            "env": {
              "PORT": "{{middlewarehouse_port}}",
              "DB_SSLMODE": "disable",
              "SCHEMA_REGISTRY_URL": "http://{{schema_server}}",
              "DB_NAME": "{{middlewarehouse_db_name}}",
              "PHOENIX_URL": "http://{{phoenix_server}}",
              "ZOOKEEPER_URL": "{{zookeeper_server}}",
              "LOG_LEVEL": "info",
              "DB_HOST": "{{docker_db_host}}",
              "KAFKA_BROKER": "{{kafka_server}}",
              "DB_USER": "middlewarehouse"
            },
            "constraints": [["hostname", "UNIQUE"]],
            "healthChecks": [
              {
                "path": "/v1/public/ping",
                "protocol": "HTTP",
                "gracePeriodSeconds": 300,
                "intervalSeconds": 30,
                "timeoutSeconds": 20,
                "maxConsecutiveFailures": 3,
                "ignoreHttp1xx": false,
                "port": {{middlewarehouse_port}}
              }
            ]
        },
      ]
    },
    {
      "id": "core-services",
      "apps":[
        {
          "id": "hyperion",
          "cmd": null,
          "cpus": 0.5,
          "mem": 256,
          "disk": 0,
          "instances": 1,
          "labels": {
            "LAYER": "backend",
            "LANG": "elixir",
            "consul": "hyperion",
            "TAG": "{{docker_tags.hyperion}}"
          },
          "env": {
            "HYPERION_DB_USER": "{{hyperion_db_user}}",
            "HYPERION_DB_HOST": "{{docker_db_host}}",
            "HYPERION_DB_NAME": "{{hyperion_db_name}}",
            "HYPERION_DB_TEST_NAME": "{{hyperion_db_test_name}}",
            "HYPERION_DB_PASSWORD": "",
            "AWS_ACCESS_KEY_ID": "{{hyperion_aws_access_key_id}}",
            "AWS_SECRET_ACCESS_KEY": "{{hyperion_aws_secret_access_key}}",
            "MWS_ACCESS_KEY_ID": "{{hyperion_mws_access_key_id}}",
            "MWS_SECRET_ACCESS_KEY" : "{{hyperion_mws_secret_access_key}}",
            "PHOENIX_USER": "{{phoenix_api_user}}",
            "PHOENIX_PASSWORD": "{{phoenix_api_password}}",
            "PHOENIX_ORG": "{{phoenix_api_user_org}}",
            "PHOENIX_URL": "https://{{storefront_server_name}}",
            "PUBLIC_KEY": "{{public_keys_dest_dir}}/public_key.pem",
            "PUSH_CHECK_INTERVAL": "{{hyperion_push_check_interval}}",
            "CREATE_ASHES_PLUGIN": "{{hyperion_create_plugin_in_ashes_on_start}}"
          },
          "constraints": [["hostname", "UNIQUE"]],
          "container": {
            "type": "DOCKER",
            "volumes": [
              {
                "containerPath": "{{public_keys_dest_dir}}",
                "hostPath": "{{public_keys_dest_dir}}",
                "mode": "RO"
              },
              {
                "containerPath": "{{docker_logs_dir}}",
                "hostPath": "{{docker_logs_host_dir}}",
                "mode": "RW"
              }
            ],
            "docker": {
              "image": "{{docker_registry}}:5000/hyperion:{{docker_tags.hyperion}}",
              "network": "HOST",
              "privileged": false,
              "parameters": [],
              "forcePullImage": true
            }
          },
          "healthChecks": [
            {
              "path": "/v1/public/health",
              "protocol": "HTTP",
              "gracePeriodSeconds": 300,
              "intervalSeconds": 30,
              "timeoutSeconds": 20,
              "maxConsecutiveFailures": 3,
              "ignoreHttp1xx": false,
              "portIndex": 0
            }
          ]
        },
        {
          "id": "middlewarehouse",
          "cmd": null,
          "cpus": 0.25,
          "mem": 64,
          "disk": 0,
          "instances": 1,
          "labels": {
            "LAYER": "backend",
            "LANG": "go",
            "consul": "middlewarehouse",
            "TAG": "{{docker_tags.middlewarehouse}}"
          },
          "container": {
            "type": "DOCKER",
            "volumes": [
              {
                "containerPath": "{{docker_logs_dir}}",
                "hostPath": "{{docker_logs_host_dir}}",
                "mode": "RW"
              }
            ],
            "docker": {
              "image": "{{docker_registry}}:5000/middlewarehouse:{{docker_tags.middlewarehouse}}",
              "network": "HOST",
              "privileged": false,
              "parameters": [],
              "forcePullImage": true
            }
          },
          "ports": [{{middlewarehouse_port}}],
          "env": {
            "PORT": "{{middlewarehouse_port}}",
            "DB_SSLMODE": "disable",
            "SCHEMA_REGISTRY_URL": "http://{{schema_server}}",
            "DB_NAME": "{{middlewarehouse_db_name}}",
            "PHOENIX_URL": "http://{{phoenix_server}}",
            "ZOOKEEPER_URL": "{{zookeeper_server}}",
            "LOG_LEVEL": "info",
            "DB_HOST": "{{docker_db_host}}",
            "KAFKA_BROKER": "{{kafka_server}}",
            "DB_USER": "middlewarehouse"
          },
          "constraints": [["hostname", "UNIQUE"]],
          "healthChecks": [
            {
              "path": "/v1/public/ping",
              "protocol": "HTTP",
              "gracePeriodSeconds": 300,
              "intervalSeconds": 30,
              "timeoutSeconds": 20,
              "maxConsecutiveFailures": 3,
              "ignoreHttp1xx": false,
              "port": {{middlewarehouse_port}}
            }
          ]
        },
        {
          "id": "marketplace",
          "cmd": null,
          "cpus": 1,
          "mem": 256,
          "disk": 0,
          "instances": 1,
          "labels": {
            "LAYER": "backend",
            "LANG": "elixir",
            "consul": "marketplace",
            "TAG": "{{docker_tags.marketplace}}"
          },
          "env": {
            "DB_NAME": "{{marketplace_db_name}}",
            "PHOENIX_URL": "{{phoenix_host}}",
            "PHOENIX_PORT": "{{phoenix_port}}",
            "SOLOMON_URL": "{{solomon_host}}",
            "DB_HOST": "{{docker_db_host}}",
            "DB_USER": "{{marketplace_db_user}}",
            "DB_PASSWORD": "",
            "SOLOMON_PORT": "{{solomon_port}}",
            "PUBLIC_KEY": "{{public_keys_dest_dir}}/public_key.pem",
            "STRIPE_API_KEY": "{{stripe_api_key}}"
          },
          "container": {
            "type": "DOCKER",
            "volumes": [
              {
                "containerPath": "{{public_keys_dest_dir}}",
                "hostPath": "{{public_keys_dest_dir}}",
                "mode": "RO"
              }
            ],
            "docker": {
              "image": "{{docker_registry}}:5000/marketplace:{{docker_tags.marketplace}}",
              "network": "HOST",
              "privileged": false,
              "parameters": [],
              "forcePullImage": true
            }
          },
          "healthChecks": [
            {
              "path": "/ping",
              "protocol": "HTTP",
              "gracePeriodSeconds": 300,
              "intervalSeconds": 30,
              "timeoutSeconds": 20,
              "maxConsecutiveFailures": 3,
              "ignoreHttp1xx": false,
              "portIndex": 0
            }
          ]
        },
        {
          "id": "peacock",
          "cmd": null,
          "cpus": 1,
          "mem": 1024,
          "disk": 0,
          "instances": 1,
          "labels": {
            "LAYER": "frontend",
            "LANG": "js",
            "consul": "peacock",
            "TAG": "{{docker_tags.peacock}}"
          },
          "env": {
            "API_URL": "https://{{storefront_server_name}}",
            "NODE_ENV": "production",
            "PHOENIX_PUBLIC_KEY": "/keys/public_key.pem",
            "STRIPE_PUBLISHABLE_KEY": "{{stripe_publishable_key}}",
            "MAILCHIMP_API_KEY": "{{mailchimp_api_key}}",
            "CONTACT_EMAIL": "{{contact_email}}",
            "GA_TRACKING_ID": "{{ga_tracking_id}}",
            "IMGIX_PRODUCTS_SOURCE": "{{imgix_products_source}}",
            "S3_BUCKET_NAME": "{{imgix_s3_bucket_name}}",
            "S3_BUCKET_PREFIX": "{{imgix_s3_bucket_prefix}}"
          },
          "healthChecks": [
            {
              "path": "/",
              "protocol": "HTTP",
              "gracePeriodSeconds": 300,
              "intervalSeconds": 30,
              "timeoutSeconds": 20,
              "maxConsecutiveFailures": 3,
              "ignoreHttp1xx": false,
              "portIndex": 0
            }
          ],
          "container": {
            "type": "DOCKER",
            "volumes": [
              {
                "containerPath": "/keys",
                "hostPath": "{{public_keys_dest_dir}}",
                "mode": "RO"
              },
              {
                "containerPath": "{{docker_logs_dir}}",
                "hostPath": "{{docker_logs_host_dir}}",
                "mode": "RW"
              }
            ],
            "docker": {
              "image": "{{docker_registry}}:5000/peacock:{{docker_tags.peacock}}",
              "network": "HOST",
              "privileged": false,
              "parameters": [],
              "forcePullImage": true
            }
          }
        }
      ],
      "dependencies": ["/highlander/core"],
    },
    {
      "id": "/highlander/ashes",
      "dependencies": ["/highlander/core", "/highlander/core/services"],
      "apps": [
        {
          "id": "/highlander/core/ashes",
          "cmd": null,
          "cpus": 1,
          "mem": 2048,
          "disk": 0,
          "instances": 1,
          "env": {
            "NODE_ENV": "production",
            "PHOENIX_PUBLIC_KEY": "/keys/public_key.pem",
            "BEHIND_NGINX": "true",
            "STRIPE_PUBLISHABLE_KEY": "{{stripe_publishable_key}}",
            "GA_TRACKING_ID": "{{ashes_ga_tracking_id}}"
          },
          "labels": {
            "LAYER": "frontend",
            "LANG": "javascript",
            "consul": "ashes",
            "TAG": "{{docker_tags.ashes}}"
          },
          "healthChecks": [
            {
              "path": "/admin/login",
              "protocol": "HTTP",
              "gracePeriodSeconds": 300,
              "intervalSeconds": 30,
              "timeoutSeconds": 20,
              "maxConsecutiveFailures": 3,
              "ignoreHttp1xx": false,
              "portIndex": 0
            }
          ],
          "container": {
            "type": "DOCKER",
            "volumes": [
              {
                "containerPath": "/keys",
                "hostPath": "{{public_keys_dest_dir}}",
                "mode": "RO"
              },
              {
                "containerPath": "{{docker_logs_dir}}",
                "hostPath": "{{docker_logs_host_dir}}",
                "mode": "RW"
              }
            ],
            "docker": {
              "image": "{{docker_registry}}:5000/ashes:{{docker_tags.ashes}}",
              "network": "HOST",
              "privileged": false,
              "parameters": [],
              "forcePullImage": true
            }
          }
        }
      ]
    },
    {
      "id": "/highlander/core/storefront",
      "apps": [
        {
          "id": "/ashes",
          "cmd": null,
          "cpus": 1,
          "mem": 2048,
          "disk": 0,
          "instances": 1,
          "env": {
            "NODE_ENV": "production",
            "PHOENIX_PUBLIC_KEY": "/keys/public_key.pem",
            "BEHIND_NGINX": "true",
            "STRIPE_PUBLISHABLE_KEY": "{{stripe_publishable_key}}",
            "GA_TRACKING_ID": "{{ashes_ga_tracking_id}}"
          },
          "labels": {
            "LAYER": "frontend",
            "LANG": "javascript",
            "consul": "ashes",
            "TAG": "{{docker_tags.ashes}}"
          },
          "healthChecks": [
            {
              "path": "/admin/login",
              "protocol": "HTTP",
              "gracePeriodSeconds": 300,
              "intervalSeconds": 30,
              "timeoutSeconds": 20,
              "maxConsecutiveFailures": 3,
              "ignoreHttp1xx": false,
              "portIndex": 0
            }
          ],
          "container": {
            "type": "DOCKER",
            "volumes": [
              {
                "containerPath": "/keys",
                "hostPath": "{{public_keys_dest_dir}}",
                "mode": "RO"
              },
              {
                "containerPath": "{{docker_logs_dir}}",
                "hostPath": "{{docker_logs_host_dir}}",
                "mode": "RW"
              }
            ],
            "docker": {
              "image": "{{docker_registry}}:5000/ashes:{{docker_tags.ashes}}",
              "network": "HOST",
              "privileged": false,
              "parameters": [],
              "forcePullImage": true
            }
          }
        }
        {
          "id": "/highlander/core/storefront",
          "cmd": null,
          "cpus": 1,
          "mem": 1024,
          "disk": 0,
          "instances": 1,
          "labels": {
            "LAYER": "frontend",
            "LANG": "js",
            "consul": "firebrand",
            "TAG": "{{docker_tags.firebrand}}"
          },
          "env": {
            "API_URL": "https://{{storefront_server_name}}",
            "NODE_ENV": "production",
            "PHOENIX_PUBLIC_KEY": "/keys/public_key.pem",
            "STRIPE_PUBLISHABLE_KEY": "{{stripe_publishable_key}}"
          },
          "healthChecks": [
            {
              "path": "/",
              "protocol": "HTTP",
              "gracePeriodSeconds": 300,
              "intervalSeconds": 30,
              "timeoutSeconds": 20,
              "maxConsecutiveFailures": 3,
              "ignoreHttp1xx": false,
              "portIndex": 0
            }
          ],
          "container": {
            "type": "DOCKER",
            "volumes": [
              {
                "containerPath": "/keys",
                "hostPath": "{{public_keys_dest_dir}}",
                "mode": "RO"
              },
              {
                "containerPath": "{{docker_logs_dir}}",
                "hostPath": "{{docker_logs_host_dir}}",
                "mode": "RW"
              }
            ],
            "docker": {
              "image": "{{docker_registry}}:5000/firebrand:{{docker_tags.firebrand}}",
              "network": "HOST",
              "privileged": false,
              "parameters": [],
              "forcePullImage": true
            }
          }
        }

      ],
      "dependencies": ["/highlander/core", "/highlander/core/services"],
    }
  ]
}