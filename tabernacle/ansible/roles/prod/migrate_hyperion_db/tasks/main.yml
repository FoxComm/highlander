---

- include_vars: ../../../base/db/vars/main.yml

- include: ../../../base/db/tasks/flyway.yml
  when: download_flyway

- name: Synchronize Middlewarehouse SQL
  synchronize: src="{{hyperion_src}}/sql" dest="{{hyperion_dir}}" delete=yes recursive=yes

- name: Copy Flyway Config
  template: src=flyway.conf.j2 dest="{{hyperion_dir}}/sql/flyway.conf"

- name: Repair Flyway Schema
  shell: FLYWAY_HOME={{flyway_dir}} {{flyway}} repair
  become: true
  args:
    chdir: "{{hyperion_dir}}"

- name: Migrate Database
  shell: FLYWAY_HOME={{flyway_dir}} {{flyway}} migrate
  become: true
  args:
    chdir: "{{hyperion_dir}}"
