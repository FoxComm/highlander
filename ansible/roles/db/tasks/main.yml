---

- name: Update System Package Cache
  apt: update_cache=yes
  sudo: true

- name: Install Packages
  apt: name={{ item }} state=latest force=yes
  sudo: true
  with_items:
    - make 
    - jq 
    - debconf-utils 
    - cmake 
    - openjdk-8-jdk
    - build-essential 
    - libpq-dev 
    - libcurl4-openssl-dev 
    - libjansson-dev 
    - pkg-config 
    - librdkafka-dev 
    - libsnappy-dev 
    - postgresql-server-dev-9.4 
    - postgresql-9.4 
    - postgresql-client-9.4 
    - postgresql-contrib-9.4
 
- name: Get Avro
  get_url: url={{avro_url}} dest="{{home}}/{{avro_name}}.tar.gz"
 
- name: Unzip Avro
  unarchive: src="{{home}}/{{avro_name}}.tar.gz" dest="{{home}}" copy=no

- name: Make Avro Build Dir
  file: path="{{avro_dir}}/build" state=directory

- name: Run CMake for Avro
  shell: cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local -DCMAKE_BUILD_TYPE=RelWithDebInfo
  args:
    chdir: "{{avro_dir}}/build"

- name: Compile and Install Avro
  shell: make && make test && make install && ldconfig
  sudo: true
  args:
    chdir: "{{avro_dir}}/build"

- name: Setup Libsnappy
  copy: src=libsnappy.pc dest=/usr/local/lib/pkgconfig/libsnappy.pc 
  sudo: true
 
- name: Synchronize Bottledwater
  synchronize: src={{bottledwater_src}} dest={{bottledwater_dir}}

- name: Make and Install BottledWater
  shell: make && make install
  args:
    chdir: "{{bottledwater_dir}}"
  sudo: true

- name: Symlink Bottledwater Executable
  file: src="{{bottledwater_dir}}/kafka/bottledwater" dest="/usr/local/bin/bottledwater" state=link
  sudo: true

- name: Get Flyway
  get_url: url={{flyway_url}} dest={{home}}/flyway.tar.gz
 
- name: Unzip Flyway 
  unarchive: src={{home}}/flyway.tar.gz dest=/usr/local/share copy=no
  sudo: true

- name: Make Flyway Executable
  file: path={{flyway_dir}}/flyway mode="u+x,g+x,o+x"
  sudo: true

- name: Add Flyway Home
  lineinfile: dest=/etc/profile line="FLYWAY_HOME={{flyway_dir}}"
  sudo: true

- name: Add Flyway Path
  lineinfile: dest=/etc/profile line="PATH=$PATH:$FLYWAY_HOME" insertafter="^FLYWAY"
  sudo: true

- name: Copy Postgres Configuration
  copy: src={{item}} dest="/etc/postgresql/9.4/main/{{item}}" mode="644"
  sudo: true
  with_items:
      - postgresql.conf
      - pg_hba.conf
  
- name: Configure Db Users
  shell: sudo -u postgres createuser -s {{item}} || true
  with_items:
      - root
      - vagrant
      - phoenix

- name: Create Db
  shell: sudo -u postgres createdb {{phoenix_db_name}} || true
  sudo: true

- name: Reload Postgresql
  service: name=postgresql state=restarted sleep=5
  sudo: true

- name: Kill Bottledwater if it is Running
  shell: systemctl stop bottledwater || true
  sudo: true

- name: Create {{phoenix_dir}}
  file: path={{phoenix_dir}} state=directory owner="{{user}}"
  sudo: true

- name: Syncrhonize Phoenix Sql
  synchronize: src="{{phoenix_src}}/sql" dest="{{phoenix_dir}}"
  sudo: true

- name: Copy Phoenix
  copy: src="{{phoenix_jar_src}}" dest="{{phoenix_jar}}" owner="{{user}}"
  sudo: true

- name: Clean Db 
  shell: sudo -u postgres FLYWAY_HOME={{flyway_dir}} {{flyway}} clean
  args:
    chdir: "{{phoenix_dir}}"

- name: Migrate Db
  shell: sudo -u postgres FLYWAY_HOME={{flyway_dir}} {{flyway}} migrate
  args:
    chdir: "{{phoenix_dir}}"

- name: Seed Db
  shell: java -cp {{phoenix_jar}} utils.seeds.Seeds
  args:
    chdir: "{{phoenix_dir}}"

- name: Copy Bottledwater Run File
  copy: src=run_bottledwater.sh dest="/usr/local/bin/run_bottledwater.sh" mode="u+x,g+x,o+x"
  sudo: true

- name: Copy Bottledwater Service
  copy: src=bottledwater.service dest="{{dest_services}}/bottledwater.service"
  sudo: true

- name: Start Bottledwater
  service: name=bottledwater state=started enabled=yes
  sudo: true

- name: Setup Update Materialzied Views Sql
  copy: src=update_materialized_views.sql dest={{update_materialized_views_sql}}
  sudo: true

- name: Setup Materialized Views Cron
  cron: name="update materialized views" minute="*" hour="*" day="*" job="psql {{db_connection_string}} -f {{update_materialized_views_sql}}"

