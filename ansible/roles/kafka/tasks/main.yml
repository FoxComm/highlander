---
- name: Add Confluent Key
  apt_key: url=http://packages.confluent.io/deb/2.0/archive.key
  sudo: true

- name: Add Confluent Repository
  apt_repository: repo='deb [arch=amd64] http://packages.confluent.io/deb/2.0 stable main' state=present update_cache=yes
  sudo: true

- name: Install Packages
  apt: name=confluent-platform-2.11.7 state=latest force=yes
  sudo: true

- name: Copy Kafka Service Files
  copy: src={{ item }} dest={{dest_services}}/
  sudo: true
  with_items:
    - zookeeper.service
    - kafka.service
    - schema-registry.service

- name: Reload Systemd for Kafka Related Services
  sudo: yes
  command: systemctl daemon-reload

- name: Kill Zookeeper if it is Running
  shell: systemctl stop zookeeper || true
  sudo: true

- name: Purge Zookeeper Data
  file: path=/var/lib/zookeeper state=absent
  sudo: true

- name: Kill Kafka if it is Running
  shell: systemctl stop kafka || true
  sudo: true

- name: Purge Kafka Queue
  file: path=/var/lib/kafka state=absent
  sudo: true

- name: Create Kafka dir
  file: path=/var/lib/kafka state=directory
  sudo: true

- name: Kafka and Zookeeper
  service: name={{ item }} state=started enabled=yes
  sudo: true
  with_items:
    - zookeeper
    - kafka

- name: Sleep
  shell: sleep 5

- name: Setup Schema Registry
  service: name=schema-registry state=restarted enabled=yes 
  sudo: true

- name: Sleep
  shell: sleep 10

#https://github.com/confluentinc/bottledwater-pg/issues/1      
- name:
  uri:
    url: http://localhost:8081/config
    method: "PUT"
    body: "{\"compatibility\": \"NONE\"}"
    HEADER_Content-Type: "application/vnd.schemaregistry.v1+json"

