---

- name: Kill Bottledwater if it is Running
  shell: systemctl stop bottledwater || true
  sudo: true

- name: Kill Materialized Views if it is Running
  shell: systemctl stop materialized_views || true
  sudo: true

- name: Restart Postgres
  service: name=postgresql state=restarted
  sudo: true

- name: Create Db
  postgresql_db: name={{phoenix_db_name}} encoding='UTF-8' lc_ctype='en_US.UTF-8' lc_collate='en_US.UTF-8' template='template0'
  sudo: true

- name: Configure Db Users
  postgresql_user: name={{item}} state=present role_attr_flags=SUPERUSER
  sudo: true
  with_items:
      - root
      - "'{{user}}'"
      - phoenix

- name: Create Phoenix Directory
  file: path={{phoenix_dir}} state=directory owner="{{user}}"
  sudo: true

- name: Syncrhonize Phoenix Sql
  synchronize: src="{{phoenix_src}}/sql" dest="{{phoenix_dir}}" delete=yes recursive=yes
  sudo: true

- name: Delete Phoenix Gatling Resources
  file: path="{{phoenix_dir}}/gatling-classes" state=absent
  sudo: true

- name: Delete Phoenix Gatling Results
  file: path="{{phoenix_dir}}/gatling-results" state=absent
  sudo: true

- name: Syncrhonize Phoenix Gatling Resources
  synchronize: src="{{phoenix_src}}/gatling-classes" dest="{{phoenix_dir}}" delete=yes recursive=yes
  become: false

- name: Create directory for Gatling results
  file: path="{{phoenix_dir}}/gatling-results" state=directory owner="{{user}}" mode="0777"

- name: Delete old log directory
  file: path="{{phoenix_dir}}/log" state=absent

- name: Create log directory
  file: path="{{phoenix_dir}}/log" state=directory owner="{{user}}"  mode="0777"

- name: Copy Phoenix
  copy: src="{{phoenix_jar_src}}" dest="{{phoenix_jar}}" owner="{{user}}"
  sudo: true

- name: Setup restore db cmd
  copy: src={{item}} dest="{{usr_local}}/bin/{{item}}" mode="0777"
  with_items:
    - restore_db.sh
    - backup_db.sh
  sudo: true

- name: Download gcsfuse
  get_url: url=https://github.com/GoogleCloudPlatform/gcsfuse/releases/download/v0.18.2/gcsfuse_0.18.2_amd64.deb dest=/tmp/gcsfuse_0.18.2_amd64.deb

- name: Install gcsfuse
  shell: dpkg -i /tmp/gcsfuse_0.18.2_amd64.deb
  sudo: true

- name: Create backup dir
  file: path=/mnt/backups owner={{user}} state=directory
  sudo: true

- name: Make sure keys dir exist
  file: path=/etc/keys state=directory owner={{user}} mode="0700"
  sudo: true

- name: Copy GCE service account key
  copyv: gce_stage_backup_service_key.json dest=/etc/keys/ mode="0600" owner={{user}}
  sudo: true

- name: Add service which mount backup dir
  template: src=backup_mount.service dest={{dest_services}}/backup_mount.service
  sudo: true

- name: Start backup_mount service
  service: name=backup_mount state=started enabled=yes sleep=5
  sudo: true

- name: Setup Update Materialzied Views Sql
  copy: src=update_materialized_views.sql dest={{update_materialized_views_sql}}
  sudo: true

- name: Setup Materialized Views Cmd
  template: src=update_materialized_views_forever.sh dest="{{usr_local}}/bin/update_materialized_views_forever.sh" mode="u+x,g+x,o+x"
  sudo: true

- name: Setup Materialized Views Service
  copy: src=materialized_views.service dest="{{dest_services}}/materialized_views.service"
  sudo: true

- name: Setup cron files for refresh customers ranking view
  template: src=refresh_customer_ranks.sh dest="{{usr_local}}/bin/refresh_customer_ranks.sh" mode="u+x,g+x,o+x"
  sudo: true

- name: Setup cron files for refresh products catalog view
  template: src=refresh_products_catalog.sh dest="{{usr_local}}/bin/refresh_products_catalog.sh" mode="u+x,g+x,o+x"
  sudo: true

- name: Clean Db
  shell: sudo -u root FLYWAY_HOME={{flyway_dir}} {{flyway}} clean
  args:
    chdir: "{{phoenix_dir}}"

- name: Migrate Db
  shell: sudo -u root FLYWAY_HOME={{flyway_dir}} {{flyway}} migrate
  args:
    chdir: "{{phoenix_dir}}"

- name: Seed Db
  shell: java -cp {{phoenix_jar}} {{seeds_cmd}}
  sudo: true
  args:
    chdir: "{{phoenix_dir}}"

- name: Setup cron for refresh customers ranking view
  cron: name="refresh customer ranking" minute="*/5" job="{{usr_local}}/bin/refresh_customer_ranks.sh > /dev/null"
  sudo: true

- name: Setup cron for refresh products catalog view
  cron: name="refresh customer ranking" minute="*" job="{{usr_local}}/bin/refresh_products_catalog.sh > /dev/null"
  sudo: true

- name: Setup cron for db backup
  cron: name="db backup" minute="30" hour="4" job="{{usr_local}}/backup_db.sh {{db_backup_dir}}/{{db_name}}_$(date +%F_%H_%M)" {{db_name}}" 
  sudo: true

- name: Reload Systemd for Materilized Views
  sudo: yes
  command: systemctl daemon-reload

- name: Start Materialized Views Service
  service: name=materialized_views state=started enabled=yes sleep=5
  sudo: true

- name: Start Bottledwater
  service: name=bottledwater state=started enabled=yes sleep=10
  sudo: true
