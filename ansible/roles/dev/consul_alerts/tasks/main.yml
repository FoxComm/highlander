---

- name: Build Consul Alerts from Fork Repository
  command: go get github.com/kpashka/consul-alerts

- name: Install Consulate
  shell: sudo easy_install consulate

- name: Copy Consul Alerts Binary
  command: mv $GOPATH/bin/consul-alerts /usr/local/bin/consul-alerts
  sudo: true

- name: Make Consul Alerts Executable
  command: chmod +x /usr/local/bin/consul-alerts
  sudo: true

- name: Copy Execution File
  template: src=run_consul_alerts.sh dest=/usr/local/bin/run_consul_alerts.sh mode="u+x,g+x,o+x"
  sudo: true

- name: Copy Configuration File
  template: src=alerts_config.json dest={{home}}/alerts_config.json mode="u+x,g+x,o+x"
  sudo: true

- name: Copy Service
  template: src=consul_alerts.service dest="{{dest_services}}/consul_alerts.service"
  sudo: true

- name: Copy Configuration to Consul KV
  shell: consulate kv restore -f {{home}}/alerts_config.json

- name: Reload Systemd for Consul Alerts
  command: systemctl daemon-reload
  sudo: true

- name: Restart Consul Alerts
  service: name=consul_alerts state=restarted enabled=yes
  sudo: true
