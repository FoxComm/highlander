---

- name: Install gulp globally
  shell: npm install gulp -g
  sudo: true

- name: Synchronize Firebird code
  synchronize:
    src: '{{firebird_source_dir}}'
    dest: '{{home}}'
    delete: true
    recursive: true
    rsync_opts:
        - "--quiet"
        - "--no-motd"
        - "--exclude=./node_modules"

- name: Install local gulp
  shell: npm install gulp
  args:
    chdir: "{{firebird_install_dir}}"

- name: Build node dependencies
  shell: npm build
  args:
    chdir: "{{firebird_install_dir}}"

- name: Build node dependencies
  shell: npm install
  args:
    chdir: "{{firebird_install_dir}}"

- name: Build Firebird
  shell: NODE_ENV={{firebird_env}} DEMO_USER={{demo_user}} DEMO_PASS={{demo_pass}} FIREBIRD_LANGUAGE={{firebird_language}} gulp build
  args:
    chdir: "{{firebird_install_dir}}"

- name: Install firebird run script
  sudo: true
  template: src=run_firebird.sh.j2 dest="{{ firebird_install_dir }}/run_firebird.sh" mode="u=rwx,g=rwx,o=r"

- name: Install firebird service entry
  sudo: true
  template:
    src: firebird.service.j2
    dest: "{{dest_services}}/firebird.service"

- name: Reload Systemd for Firebird
  sudo: yes
  command: systemctl daemon-reload

- name: Restart Firebird
  service: name=firebird state=restarted
  sudo: true
