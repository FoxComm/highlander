---

- name: Synchronize Gatling Test Code
  synchronize:
    src: '{{gatling_source_dir}}'
    dest: '{{home}}'
    delete: true
    recursive: true
    rsync_opts:
        - "--no-motd"
        - "--exclude=target"

- name: Setup Gatling Run Script
  template: src=run_tests.sh dest={{gatling_install_dir}}/run_tests.sh mode="u=rwx,g=rwx,o=r"

- name: Install nginx dependencies
  apt: name={{ item }} force=yes state=latest
  with_items:
    - lua-cjson
    - lua-cjson-dev
    - nginx-extras
  sudo: true

- name: Assign {{user}} to Group www-data
  user: name={{user}} groups=www-data
  sudo: true

- name: Give it magical access.
  file: path={{gatling_install_dir}}/target state=directory mode="u=rwx,g=rwx,o=rwx"
  sudo: true

- name: Setup symlink to gatling results
  file: src={{gatling_install_dir}}/target/gatling dest=/var/www/gatling state=link
  sudo: true

- name: Install default hosts
  template: src=default.j2 dest=/etc/nginx/sites-available/default
  sudo: true

- name: Restart Nginx
  service: name=nginx state=reloaded
  sudo: yes




