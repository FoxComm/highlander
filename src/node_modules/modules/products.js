/* @flow */

import _ from 'lodash';
import { createAction, createReducer } from 'redux-act';

const productsFetchStated = createAction('PRODUCTS_FETCH_STARTED');
const productsFetchSucceded = createAction('PRODUCTS_FETCH_SUCCEDED');
const productsFetchFailed = createAction('PRODUCTS_FETCH_FAILED');

export type Product = {
  id: number;
  name: string;
  imageUrl: string;
  price: string;
  categories: Array<number>;
}

type FormData = {
  isFetching: boolean;
  list: Array<Product>;
}

const mockedData : Array<Product> = [
  {
    id: 1,
    name: 'Donkey',
    imageUrl: 'https://placehold.it/350x350',
    price: '55$',
    categories: [2],
  },
  {
    id: 2,
    name: 'Shark',
    imageUrl: 'https://placehold.it/350x350',
    price: '20$',
    categories: [2, 3],
  },
  {
    id: 3,
    name: 'Sharkling',
    imageUrl: 'https://placehold.it/350x350',
    price: '30$',
    categories: [3],
  },
  {
    id: 4,
    name: 'Duck',
    imageUrl: 'https://placehold.it/350x350',
    price: '40$',
    categories: [3, 4],
  },
  {
    id: 5,
    name: 'Duckling',
    imageUrl: 'https://placehold.it/350x350',
    price: '100$',
    categories: [4],
  },
  {
    id: 6,
    name: 'Chicken',
    imageUrl: 'https://placehold.it/350x350',
    price: '60$',
    categories: [4, 2],
  },
  {
    id: 7,
    name: 'Fox',
    imageUrl: 'https://placehold.it/350x350',
    price: '87$',
    categories: [4, 2, 3],
  },
];

export function fetchProducts(categoryId: ?number): Function {
  return dispatch => {
    dispatch(productsFetchStated());

    if (categoryId == undefined) {
      return dispatch(productsFetchSucceded(mockedData));
    }

    const result = _.filter(mockedData, (item) => _.includes(item.categories, categoryId));
    return dispatch(productsFetchSucceded(result));
  };
}

const initialState: FormData = {
  isFetching: false,
  list: [],
};

const reducer = createReducer({
  [productsFetchStated]: state => {
    return {
      ...state,
      isFetching: true,
    };
  },
  [productsFetchSucceded]: (state, payload) => {
    return {
      ...state,
      list: payload,
      isFetching: false,
    };
  },
  [productsFetchFailed]: (state, err) => {
    console.error(err);

    return {
      ...state,
      isFetching: false,
    };
  },
}, initialState);

export default reducer;
